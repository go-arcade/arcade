syntax = "proto3";

package agent.v1;

import "task/v1/task.proto";

option go_package = "github.com/observabil/arcade/api/agent/v1;agentv1";

// Agent服务 - Agent端与Server端通信的主要接口
service AgentService {
    // 心跳保持 - Agent定期向Server发送心跳
    rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse) {}

    // Agent注册 - Agent启动时向Server注册
    rpc Register(RegisterRequest) returns (RegisterResponse) {}

    // Agent注销 - Agent关闭时向Server注销
    rpc Unregister(UnregisterRequest) returns (UnregisterResponse) {}

    // 获取任务 - Agent主动拉取待执行的任务
    rpc FetchTask(FetchTaskRequest) returns (FetchTaskResponse) {}

    // 上报任务状态 - Agent执行任务过程中上报状态变化
    rpc ReportTaskStatus(ReportTaskStatusRequest) returns (ReportTaskStatusResponse) {}

    // 上报任务日志 - Agent批量上报任务执行日志
    rpc ReportTaskLog(ReportTaskLogRequest) returns (ReportTaskLogResponse) {}

    // 取消任务 - Server通知Agent取消正在执行的任务
    rpc CancelTask(CancelTaskRequest) returns (CancelTaskResponse) {}

    // 更新Agent标签 - 动态更新Agent的labels
    rpc UpdateLabels(UpdateLabelsRequest) returns (UpdateLabelsResponse) {}

    // 下载插件 - Agent从Server下载插件
    rpc DownloadPlugin(DownloadPluginRequest) returns (DownloadPluginResponse) {}

    // 列出可用插件 - Agent查询可用的插件列表
    rpc ListAvailablePlugins(ListAvailablePluginsRequest) returns (ListAvailablePluginsResponse) {}
}

// Agent状态枚举
enum AgentStatus {
  AGENT_STATUS_UNSPECIFIED = 0;
  AGENT_STATUS_ONLINE = 1;   // 在线
  AGENT_STATUS_OFFLINE = 2;  // 离线
  AGENT_STATUS_BUSY = 3;     // 忙碌
  AGENT_STATUS_IDLE = 4;     // 空闲
}

// 心跳请求
message HeartbeatRequest {
  string agent_id = 1;                // Agent唯一标识
  AgentStatus status = 2;             // Agent当前状态
  int32 running_jobs_count = 3;       // 正在执行的任务数
  int32 max_concurrent_jobs = 4;      // 最大并发任务数
  map<string, string> metrics = 5;    // Agent指标（CPU、内存等）
  map<string, string> labels = 6;     // Agent标签（可动态更新）
}

// 心跳响应
message HeartbeatResponse {
  bool success = 1;
  string message = 2;
  int64 timestamp = 3;              // 服务器时间戳（用于时间同步）
}

// Agent注册请求
message RegisterRequest {
  string agent_id = 1;                // Agent唯一标识（可选，不提供则由Server生成）
  string hostname = 2;                // 主机名
  string ip = 3;                      // IP地址
  string os = 4;                      // 操作系统
  string arch = 5;                    // 架构（amd64、arm64等）
  string version = 6;                 // Agent版本
  int32 max_concurrent_jobs = 7;      // 最大并发任务数
  map<string, string> labels = 8;     // 自定义标签
  repeated string installed_plugins = 9; // Agent已安装的插件列表
}

// Agent注册响应
message RegisterResponse {
  bool success = 1;
  string message = 2;
  string agent_id = 3;                // Server分配或确认的Agent ID
  int64 heartbeat_interval = 4;       // 心跳间隔（秒）
}

// Agent注销请求
message UnregisterRequest {
  string agent_id = 1;
  string reason = 2;                  // 注销原因
}

// Agent注销响应
message UnregisterResponse {
  bool success = 1;
  string message = 2;
}

// 获取任务请求
message FetchTaskRequest {
  string agent_id = 1;
  int32 max_jobs = 2;                 // 最多获取的任务数
  map<string, string> labels = 3;     // Agent标签（用于任务匹配）
}

// 获取任务响应
message FetchTaskResponse {
  bool success = 1;
  string message = 2;
  repeated Task tasks = 3;              // 待执行的任务列表
}

// 任务定义
message Task {
  string job_id = 1;                  // 任务ID
  string name = 2;                    // 任务名称
  string pipeline_id = 3;             // 所属流水线ID
  int32 stage = 4;                    // 阶段序号
  repeated string commands = 5;       // 执行命令列表
  map<string, string> env = 6;        // 环境变量
  string workspace = 7;               // 工作目录
  int32 timeout = 8;                  // 超时时间（秒）
  string image = 9;                   // Docker镜像（如果需要容器执行）
  map<string, string> secrets = 10;   // 密钥信息
  repeated Artifact artifacts = 11;   // 产物配置
  LabelSelector label_selector = 12;  // 标签选择器（用于匹配Agent）
  repeated PluginInfo plugins = 13;   // 任务所需插件列表
}

// 产物定义
message Artifact {
  string name = 1;                    // 产物名称
  string path = 2;                    // 产物路径（支持glob模式）
  string destination = 3;             // 目标存储路径
}

// 上报任务状态请求
message ReportTaskStatusRequest {
  string agent_id = 1;
  string task_id = 2;
  task.v1.TaskStatus status = 3;               // 任务状态
  int32 exit_code = 4;                // 退出码
  string error_message = 5;           // 错误信息
  int64 start_time = 6;               // 开始时间（Unix时间戳）
  int64 end_time = 7;                 // 结束时间（Unix时间戳）
  map<string, string> metrics = 8;    // 任务执行指标
}

// 上报任务状态响应
message ReportTaskStatusResponse {
  bool success = 1;
  string message = 2;
}

// 上报任务日志请求
message ReportTaskLogRequest {
  string agent_id = 1;
  string task_id = 2;
  repeated LogEntry logs = 3;         // 日志条目
}

// 日志条目
message LogEntry {
  int64 timestamp = 1;                // 时间戳
  string level = 2;                   // 日志级别（info、warn、error）
  string content = 3;                 // 日志内容
  int32 line_number = 4;              // 行号
}

// 上报任务日志响应
message ReportTaskLogResponse {
  bool success = 1;
  string message = 2;
}

// 取消任务请求
message CancelTaskRequest {
  string agent_id = 1;
  string job_id = 2;
  string reason = 3;                  // 取消原因
}

// 取消任务响应
message CancelTaskResponse {
  bool success = 1;
  string message = 2;
}

// 更新Agent标签请求
message UpdateLabelsRequest {
  string agent_id = 1;
  map<string, string> labels = 2;     // 要更新的标签（完全替换）
  bool merge = 3;                     // 是否合并模式（true=合并，false=替换）
}

// 更新Agent标签响应
message UpdateLabelsResponse {
  bool success = 1;
  string message = 2;
  map<string, string> labels = 3;     // 更新后的标签
}

// 标签选择器 - 用于任务匹配Agent
message LabelSelector {
  // 匹配所有指定的标签（AND逻辑）
  map<string, string> match_labels = 1;

  // 标签表达式（支持更复杂的匹配规则）
  repeated LabelSelectorRequirement match_expressions = 2;
}

// 标签选择器要求
message LabelSelectorRequirement {
  string key = 1;                     // 标签key
  LabelOperator operator = 2;         // 操作符
  repeated string values = 3;         // 值列表
}

// 标签操作符
enum LabelOperator {
  LABEL_OPERATOR_UNSPECIFIED = 0;
  LABEL_OPERATOR_IN = 1;              // 标签值在values列表中
  LABEL_OPERATOR_NOT_IN = 2;          // 标签值不在values列表中
  LABEL_OPERATOR_EXISTS = 3;          // 标签key存在
  LABEL_OPERATOR_NOT_EXISTS = 4;      // 标签key不存在
  LABEL_OPERATOR_GT = 5;              // 标签值大于指定值（用于数值比较）
  LABEL_OPERATOR_LT = 6;              // 标签值小于指定值（用于数值比较）
}

// ============ 插件分发相关 ============

// 插件信息
message PluginInfo {
  string plugin_id = 1;               // 插件ID
  string name = 2;                    // 插件名称
  string version = 3;                 // 版本号
  string checksum = 4;                // SHA256校验和
  int64 size = 5;                     // 文件大小（字节）
  string download_url = 6;            // 下载地址（可选，用于CDN分发）
  PluginLocation location = 7;        // 插件位置
}

// 插件位置
enum PluginLocation {
  PLUGIN_LOCATION_UNSPECIFIED = 0;
  PLUGIN_LOCATION_SERVER = 1;         // 服务端文件系统
  PLUGIN_LOCATION_STORAGE = 2;        // 对象存储
  PLUGIN_LOCATION_REGISTRY = 3;       // 插件仓库
}

// 下载插件请求
message DownloadPluginRequest {
  string agent_id = 1;                // Agent ID
  string plugin_id = 2;               // 插件ID
  string version = 3;                 // 版本号（可选，不指定则下载最新版本）
}

// 下载插件响应
message DownloadPluginResponse {
  bool success = 1;                   // 是否成功
  string message = 2;                 // 消息
  bytes plugin_data = 3;              // 插件二进制数据
  string checksum = 4;                // SHA256校验和
  int64 size = 5;                     // 文件大小
  string version = 6;                 // 实际版本号
}

// 列出可用插件请求
message ListAvailablePluginsRequest {
  string agent_id = 1;                // Agent ID
  string plugin_type = 2;             // 可选：按类型过滤（notify/ci/cd/security等）
}

// 列出可用插件响应
message ListAvailablePluginsResponse {
  bool success = 1;
  string message = 2;
  repeated PluginInfo plugins = 3;    // 可用插件列表
}
