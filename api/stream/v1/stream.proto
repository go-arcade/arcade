syntax = "proto3";

package stream.v1;

import "steprun/v1/steprun.proto";
import "agent/v1/agent.proto";
import "pipeline/v1/pipeline.proto";

option go_package = "github.com/go-arcade/arcade/api/stream/v1;streamv1";

// StreamService - Real-time data streaming interface
service StreamService {
  // Stream step run logs in real-time - Server-side streaming pushes logs to client
  rpc StreamStepRunLog(StreamStepRunLogRequest) returns (stream StreamStepRunLogResponse) {}

  // Upload step run log stream - Agent-side streaming uploads logs to Server
  rpc UploadStepRunLog(stream UploadStepRunLogRequest) returns (UploadStepRunLogResponse) {}

  // Stream step run status in real-time - Server-side streaming pushes step run (StepRun) status changes
  rpc StreamStepRunStatus(StreamStepRunStatusRequest) returns (stream StreamStepRunStatusResponse) {}

  // Stream job status in real-time - Server-side streaming pushes job (JobRun) status changes
  rpc StreamJobStatus(StreamJobStatusRequest) returns (stream StreamJobStatusResponse) {}

  // Stream pipeline status in real-time - Server-side streaming pushes pipeline (PipelineRun) status changes
  rpc StreamPipelineStatus(StreamPipelineStatusRequest) returns (stream StreamPipelineStatusResponse) {}

  // Bidirectional communication channel between Agent and Server - For real-time step run scheduling and control
  rpc AgentChannel(stream AgentChannelRequest) returns (stream AgentChannelResponse) {}

  // Monitor agent status in real-time - Server-side streaming pushes agent status changes
  rpc StreamAgentStatus(StreamAgentStatusRequest) returns (stream StreamAgentStatusResponse) {}

  // Real-time event stream - Server pushes system events
  rpc StreamEvents(StreamEventsRequest) returns (stream StreamEventsResponse) {}
}

// Agent status enum
enum AgentStatus {
  AGENT_STATUS_UNSPECIFIED = 0;
  AGENT_STATUS_ONLINE = 1;   // Online
  AGENT_STATUS_OFFLINE = 2;  // Offline
  AGENT_STATUS_BUSY = 3;     // Busy
  AGENT_STATUS_IDLE = 4;     // Idle
}

// Event type enum
enum EventType {
  EVENT_TYPE_UNSPECIFIED = 0;
  EVENT_TYPE_STEP_RUN_CREATED = 1;        // StepRun created
  EVENT_TYPE_STEP_RUN_STARTED = 2;       // StepRun started
  EVENT_TYPE_STEP_RUN_COMPLETED = 3;      // StepRun completed
  EVENT_TYPE_STEP_RUN_FAILED = 4;         // StepRun failed
  EVENT_TYPE_STEP_RUN_CANCELLED = 5;      // StepRun cancelled
  EVENT_TYPE_JOB_STARTED = 6;             // Job (JobRun) started
  EVENT_TYPE_JOB_COMPLETED = 7;           // Job (JobRun) completed
  EVENT_TYPE_JOB_FAILED = 8;              // Job (JobRun) failed
  EVENT_TYPE_JOB_CANCELLED = 9;           // Job (JobRun) cancelled
  EVENT_TYPE_PIPELINE_STARTED = 10;       // Pipeline (PipelineRun) started
  EVENT_TYPE_PIPELINE_COMPLETED = 11;     // Pipeline (PipelineRun) completed
  EVENT_TYPE_PIPELINE_FAILED = 12;        // Pipeline (PipelineRun) failed
  EVENT_TYPE_PIPELINE_CANCELLED = 13;     // Pipeline (PipelineRun) cancelled
  EVENT_TYPE_AGENT_REGISTERED = 14;      // Agent registered
  EVENT_TYPE_AGENT_UNREGISTERED = 15;     // Agent unregistered
  EVENT_TYPE_AGENT_OFFLINE = 16;          // Agent offline
}

// ============ Step Run Log Stream Related ============

// Request to stream step run logs in real-time
message StreamStepRunLogRequest {
  string step_run_id = 1;                // Step run ID (required)
  int32 from_line = 2;                   // Starting line number (0 means from beginning)
  bool follow = 3;                       // Whether to continuously track (similar to tail -f)
}

// Response for streaming step run logs in real-time
message StreamStepRunLogResponse {
  string step_run_id = 1;                // Step run ID
  LogChunk log_chunk = 2;                // Log chunk
  bool is_complete = 3;                  // Whether log transmission is complete
}

// Log chunk
message LogChunk {
  int64 timestamp = 1;                   // Timestamp (Unix timestamp in seconds)
  int32 line_number = 2;                 // Line number
  string level = 3;                      // Log level (info, warn, error, debug)
  string content = 4;                    // Log content
  string stream = 5;                     // Stream type (stdout, stderr)
}

// Request to upload step run log stream
message UploadStepRunLogRequest {
  string step_run_id = 1;                // Step run ID (required)
  string agent_id = 2;                  // Agent ID (required)
  repeated LogChunk logs = 3;           // List of log chunks
}

// Response for uploading step run log stream
message UploadStepRunLogResponse {
  bool success = 1;
  string message = 2;
  int32 received_lines = 3;              // Number of log lines received
}

// ============ Step Run Status Stream Related ============

// Request to stream step run status in real-time
message StreamStepRunStatusRequest {
  repeated string step_run_ids = 1;      // List of step run IDs (empty means monitor all step runs)
  string pipeline_id = 2;                // Pipeline ID (optional, monitor all step runs in a specific pipeline)
  string pipeline_run_id = 3;            // Pipeline run ID (optional)
  string job_id = 4;                     // Job ID (optional, monitor all step runs in a specific job)
  string job_name = 5;                   // Job name (optional)
}

// Response for streaming step run status in real-time
message StreamStepRunStatusResponse {
  string step_run_id = 1;                // Step run ID
  string pipeline_id = 2;                // Pipeline ID
  string pipeline_run_id = 3;            // Pipeline run ID
  string job_id = 4;                     // Job ID
  string job_name = 5;                   // Job name
  string step_name = 6;                  // Step name
  steprun.v1.StepRunStatus status = 7;   // Step run status
  steprun.v1.StepRunStatus previous_status = 8; // Previous status
  int64 timestamp = 9;                   // Status change timestamp (Unix timestamp in seconds)
  string agent_id = 10;                 // Executing agent ID
  int32 exit_code = 11;                  // Exit code
  string error_message = 12;             // Error message
  int64 duration = 13;                   // Execution duration (milliseconds)
  map<string, string> metrics = 14;     // Execution metrics
}

// ============ Job Status Stream Related ============

// Request to stream job status in real-time
message StreamJobStatusRequest {
  repeated string job_ids = 1;           // List of job IDs (empty means monitor all jobs)
  string pipeline_id = 2;                // Pipeline ID (optional)
  string pipeline_run_id = 3;            // Pipeline run ID (optional)
}

// Response for streaming job status in real-time
message StreamJobStatusResponse {
  string job_id = 1;                     // Job ID
  string job_name = 2;                   // Job name
  string pipeline_id = 3;                // Pipeline ID
  string pipeline_run_id = 4;            // Pipeline run ID
  pipeline.v1.PipelineStatus status = 5;  // Job status
  pipeline.v1.PipelineStatus previous_status = 6; // Previous status
  int64 timestamp = 7;                   // Status change timestamp (Unix timestamp in seconds)
  int32 total_steps = 8;                 // Total number of steps
  int32 completed_steps = 9;             // Number of completed steps
  int32 failed_steps = 10;               // Number of failed steps
  int32 running_steps = 11;              // Number of running steps
  int32 current_step_index = 12;         // Current step index
  int64 duration = 13;                   // Execution duration (milliseconds)
}

// ============ Pipeline Status Stream Related ============

// Request to stream pipeline status in real-time
message StreamPipelineStatusRequest {
  repeated string pipeline_ids = 1;      // List of pipeline IDs (empty means monitor all pipelines)
  repeated string pipeline_run_ids = 2;  // List of pipeline run IDs (optional)
}

// Response for streaming pipeline status in real-time
message StreamPipelineStatusResponse {
  string pipeline_id = 1;                // Pipeline ID
  string run_id = 2;                     // Pipeline run ID
  string namespace = 3;                  // Pipeline namespace
  pipeline.v1.PipelineStatus status = 4;  // Pipeline status
  pipeline.v1.PipelineStatus previous_status = 5; // Previous status
  int64 timestamp = 6;                   // Status change timestamp (Unix timestamp in seconds)
  int32 total_jobs = 7;                  // Total number of jobs
  int32 completed_jobs = 8;              // Number of completed jobs
  int32 failed_jobs = 9;                 // Number of failed jobs
  int32 running_jobs = 10;               // Number of running jobs
  int64 duration = 11;                   // Execution duration (milliseconds)
}

// ============ Agent Channel Related ============

// Agent channel request (bidirectional stream)
message AgentChannelRequest {
  string agent_id = 1;                   // Agent ID (required)
  string request_id = 2;                 // Request ID (for matching requests and responses)
  oneof payload {
    HeartbeatData heartbeat = 3;         // Heartbeat data
    StepRunStatusUpdate step_run_status = 4; // Step run status update
    LogData log_data = 5;                // Log data
    StepRunFetchRequest step_run_fetch = 6; // Step run fetch request
    AgentMetrics metrics = 7;            // Agent metrics
  }
}

// Heartbeat data
message HeartbeatData {
  int64 timestamp = 1;                   // Timestamp (Unix timestamp in seconds)
  agent.v1.AgentStatus status = 2;       // Agent status
  int32 running_step_runs_count = 3;     // Number of running step runs
  int32 max_concurrent_step_runs = 4;    // Maximum concurrent step runs
}

// Step run status update
message StepRunStatusUpdate {
  string step_run_id = 1;                // Step run ID (required)
  steprun.v1.StepRunStatus status = 2;   // Step run status
  int32 exit_code = 3;                  // Exit code
  string error_message = 4;              // Error message
  int64 timestamp = 5;                   // Timestamp (Unix timestamp in seconds)
}

// Log data
message LogData {
  string step_run_id = 1;                // Step run ID (required)
  repeated LogChunk logs = 2;            // List of log chunks
}

// Step run fetch request
message StepRunFetchRequest {
  int32 max_step_runs = 1;               // Maximum number of step runs to fetch (default 1)
}

// Agent metrics
message AgentMetrics {
  double cpu_usage = 1;                  // CPU usage (percentage)
  double memory_usage = 2;                // Memory usage (percentage)
  double disk_usage = 3;                 // Disk usage (percentage)
  int32 running_step_runs = 4;           // Number of running step runs
  map<string, string> custom_metrics = 5; // Custom metrics
}

// Agent channel response (bidirectional stream)
message AgentChannelResponse {
  string agent_id = 1;                  // Agent ID
  string response_id = 2;                // Response ID (corresponding to request ID)
  oneof payload {
    HeartbeatAck heartbeat_ack = 3;      // Heartbeat acknowledgment
    StepRunAssignment step_run_assignment = 4; // Step run assignment
    StepRunCancelCommand step_run_cancel_command = 5; // Step run cancellation command
    ConfigUpdate config_update = 6;      // Configuration update
  }
}

// Heartbeat acknowledgment
message HeartbeatAck {
  int64 server_time = 1;                 // Server timestamp (Unix timestamp in seconds)
  bool success = 2;
}

// Step run assignment
message StepRunAssignment {
  repeated agent.v1.StepRun step_runs = 1; // List of assigned step runs
}

// Step run cancellation command
message StepRunCancelCommand {
  string step_run_id = 1;                // Step run ID (required)
  string reason = 2;                     // Cancellation reason
}

// Configuration update
message ConfigUpdate {
  int64 heartbeat_interval = 1;          // Heartbeat interval (seconds)
  int32 max_concurrent_step_runs = 2;     // Maximum concurrent step runs
  map<string, string> config = 3;         // Other configuration
}

// ============ Agent Status Stream Related ============

// Request to monitor agent status stream in real-time
message StreamAgentStatusRequest {
  repeated string agent_ids = 1;         // List of agent IDs (empty means monitor all agents)
}

// Response for monitoring agent status stream in real-time
message StreamAgentStatusResponse {
  string agent_id = 1;                   // Agent ID
  string hostname = 2;                   // Hostname
  string ip = 3;                         // IP address
  AgentStatus status = 4;                // Agent status
  AgentStatus previous_status = 5;       // Previous status
  int64 timestamp = 6;                   // Status change timestamp (Unix timestamp in seconds)
  int32 running_step_runs_count = 7;     // Number of running step runs
  int32 max_concurrent_step_runs = 8;    // Maximum concurrent step runs
  AgentMetrics metrics = 9;              // Agent metrics
  int64 last_heartbeat = 10;             // Last heartbeat time (Unix timestamp in seconds)
  map<string, string> labels = 11;      // Agent labels
}

// ============ Event Stream Related ============

// Request for real-time event stream
message StreamEventsRequest {
  repeated EventType event_types = 1;    // Event types to watch (empty means receive all events)
  repeated string resource_ids = 2;      // Resource IDs to watch (step_run_id, job_id, pipeline_id, etc.)
  string resource_type = 3;              // Resource type filter (step_run, job, pipeline, agent, etc.)
}

// Response for real-time event stream
message StreamEventsResponse {
  string event_id = 1;                   // Event ID
  EventType event_type = 2;              // Event type
  int64 timestamp = 3;                   // Event timestamp (Unix timestamp in seconds)
  string resource_id = 4;                // Resource ID
  string resource_type = 5;              // Resource type (step_run, job, pipeline, agent, etc.)
  string title = 6;                      // Event title
  string description = 7;                // Event description
  map<string, string> metadata = 8;     // Event metadata
  string user_id = 9;                    // User ID who triggered the event
}
